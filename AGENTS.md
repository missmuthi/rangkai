# Repository Guidelines

## Project Structure & Module Organization
- `app/`: Nuxt 3 client code (pages, components, composables, layouts, types). Use file-based routing; shared UI lives in `app/components` and composables in `app/composables`.
- `server/`: Nitro backend (API routes under `server/api`, auth middleware in `server/middleware`, Drizzle schemas/migrations in `server/db`, utilities in `server/utils`). Cloudflare bindings are configured via `wrangler.toml`.
- `public/`: Static assets served as-is. `dist/` is generated by `pnpm build`; do not edit manually.
- `tests/`: Unit/integration specs under `tests/unit` and `tests/integration`, Playwright e2e in `tests/e2e`. `docs/` and `ARCHITECTURE.md` provide deeper context for flows.

## Build, Test, and Development Commands
- Install: `pnpm install` (runs `nuxt prepare` post-install).
- Develop: `pnpm dev` (localhost:3000). Use `pnpm typecheck` alongside for TS safety.
- Build: `pnpm build`; preview edge bundle with `pnpm preview`.
- Tests: `pnpm test` (Vitest), `pnpm test:coverage`, `pnpm test:e2e` (Playwright). Run `pnpm test:all` before PRs that affect both client and server logic.
- Lint/format: `pnpm lint` or `pnpm lint:fix`. Deploy to Cloudflare Pages with `pnpm deploy` (calls `wrangler pages deploy dist`).

## Coding Style & Naming Conventions
- TypeScript-first; use `<script setup lang="ts">` and Composition API. Prefer composables (`useAuth`, `useHistory`) for shared state.
- Components and layouts use PascalCase filenames; composables prefix with `use`; server routes follow Nuxt/Nitro file naming (`*.get.ts`, `*.post.ts`).
- Default to 2-space indentation and single quotes. Tailwind utilities are preferred for styling; keep class lists ordered by layout -> spacing -> color.
- ESLint config lives in `eslint.config.mjs` (Nuxt preset). Avoid `any`; unused vars are warnings. Keep `vue/no-v-html` disabled only when sanitized input is guaranteed.

## Testing Guidelines
- Unit/integration: Vitest with happy-dom. Place specs as `*.spec.ts` alongside source or under `tests/{unit,integration}` mirroring folder structure.
- E2E: Playwright specs in `tests/e2e`; prefer data-testid hooks over text selectors for stability.
- Write tests for auth flows, scan history mutations, and caching logic; add regression cases when touching `server/api` or core composables. Use `pnpm test:coverage` to watch for gaps in new code.

## Commit & Pull Request Guidelines
- Follow Conventional Commits: `type(scope): summary` (e.g., `feat(frontend): add scan grid`). Scope examples: `frontend`, `server`, `tests`, `docs`.
- Keep commits focused and include relevant tests in the message body when non-trivial. Match patterns in `COMMIT_MESSAGE.txt` for consistency.
- PRs should include: short description of change, impacted areas (app/server/tests), screenshots for UI changes, test commands run, and linked issue/phase doc when applicable.

## Security & Configuration Tips
- Keep secrets and API keys out of the repo; rely on NuxtHub/Cloudflare env bindings (`wrangler.toml`). Do not log tokens or cookies in server handlers.
- When adding routes, enforce auth in middleware and validate inputs with zod/Drizzle constraints. Cache keys in KV should be namespaced (`book:${isbn}`) to avoid collisions.
